import React, { Component } from 'react';
import Storage from 'electron-json-storage-sync';
import { Statistic } from 'semantic-ui-react';

import { getBill } from '../int/Masters';

export default class PrintPage extends Component {

  constructor(props) {
    super(props);
    this.state = {

    };
  }

  componentDidMount() {
    getBill(this.props.billNo)
      .then((row) => {
        console.log("BILL DATA=", row);
        this.setState({
          data: row[0]
        });
      })
      .catch((err) => {
        console.error("BILL DATA FETCH FAILED FOR " + this.props.billNo, err);
        this.setState({
          err: err
        });
      })
  }

  render() {
    const date = new Date();
    return (
      <div className="page">
        <div className="original copy">
          { this.renderPageHeader('office') }
          { this.renderBillDetails('office') }
          { this.renderFooter() }
        </div>
        <div className="security copy">
          { this.renderPageHeader('security') }
          { this.renderBillDetails('security') }
          { this.renderFooter() }
        </div>
      </div>
    );
  }

  renderFooter() {
    const { status, data } = Storage.get('session');
    if (status) {
      return (
        <footer>printed by <strong>{ data.user }</strong></footer>
      );
    }
  }

  renderPageHeader(copyType) {
    const date = new Date();

    return (
      <div className="printPageHeader">
        <h5>Sree Lalitha Industries Pvt Ltd.</h5>
        <h5>{ `BILL - #${this.state.data ? this.state.data.sno : ''}` }</h5>
        <h5>{ `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`}</h5>
        <p>{ `${copyType.toUpperCase()} COPY` }</p>
        <hr />
      </div>
    );
  }

  renderBillDetails(billType) {
    let statItems = [], amountItems = [];
    if (this.state.data) {
      if (billType === 'security') {
        statItems = [
          { label: 'Total Tons', value: this.state.data.totalWeightInTons.toString() },
          { label: 'Charge per Ton', value: this.state.data.chargePerTon.toString() },
          { label: 'Total Charge', value: this.state.data.totalAmount.toString() }
        ];
      } else {
        statItems = [
          { label: 'Total Tons', value: this.state.data.totalWeightInTons.toString() },
          { label: 'Charge per Ton', value: this.state.data.chargePerTon.toString() },
          { label: this.state.action === 'loading' ? 'rusum' : 'Other Charges', value: this.state.data.otherCharges.toString() }
        ];
        amountItems = [
          { label: 'Total Amount', value: this.state.data.totalAmount.toFixed(2).toString() },
          { label: 'Jattu Amount', value: this.state.data.jattuAmount.toString() },
          { label: 'Remaining', value: this.state.data.balanceAmount.toFixed(2).toString() }
        ];
      }
    }

    if (!this.state.data) {
      return
    }

    const wayBillNos = JSON.parse(this.state.data.activityRows).map((item) => item.wsno).join(',');

    return (
      <div className="orderHeader">

        <table>
          <tr>
            <td className="key">PRODUCT<span>:</span></td>
            <td className="value">{this.state.data.product.toUpperCase()}</td>
            <td className="key">ACTION<span>:</span></td>
            <td className="value">{this.state.data.action.toUpperCase()}</td>
          </tr>
          <tr>
            <td className="key">VEHICLE<span>:</span></td>
            <td className="value">{this.state.data.lorryType.toUpperCase()}</td>
            <td className="key">REGION<span>:</span></td>
            <td className="value">{this.state.data.region.toUpperCase()}</td>
          </tr>
          <tr>
            <td className="key">VEHICLE#<span>:</span></td>
            <td className="value">{this.state.data.lorryNo.toUpperCase()}</td>
            <td className="key">WSNO<span>:</span></td>
            <td className="value">{wayBillNos.toUpperCase()}</td>
          </tr>
        </table>
        <div className="summary">
          <Statistic.Group items={statItems} color='black' widths='three' size='mini'/>
          <Statistic.Group items={amountItems} color='black' widths='three' size='mini'/>
        </div>
      </div>
    );
  }
}
